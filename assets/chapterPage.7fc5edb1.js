import{Q as k}from"./QCard.70ae0f07.js";import{Q as S}from"./QSpinnerDots.8eb40a4c.js";import{Q as C}from"./QInfiniteScroll.a7c6b959.js";import{Q as L}from"./QPage.32043b58.js";import{I as D}from"./Intersection.7e467ca5.js";import{f as T,r as h,_ as R,j as r,y as l,n as c,x as g,s as v,k as _,m as u,p as B,a7 as N,u as P,v as p,z as w,F as $,D as M,t as I}from"./index.b35b6c87.js";import{Q as E}from"./QImg.4c286d18.js";import{Q as b}from"./QInnerLoading.950f1dd6.js";import{g as A}from"./usefull.e82e70c8.js";import{c as Q}from"./readerSettings.551b0ef9.js";import"./use-dark.1516cb7d.js";import"./QSpinner.cedf2831.js";import"./dom.4a68f118.js";import"./scroll.fbb25234.js";import"./use-transition.6c02567b.js";import"./fetcher.f8235356.js";const O=T({name:"displayPage",props:{pageNum:{type:Number,required:!0},chapterID:{type:Number,required:!0},vue_RM:{type:String,default:"RTL"},vue_WT:{type:Boolean,default:!1},vue_Scale:{type:Boolean,default:!1},vue_Offset:{type:Boolean,default:!1}},mounted:function(){this.getImg()},computed:{isBook(){return["RTL","LTR","SinglePage"].includes(this.vue_RM)},isBook2(){return["RTL","LTR"].includes(this.vue_RM)},imgstyle(){return this.vue_Scale?this.isBook?(this.isBook2,"width: fit-content;"):"width:100%;height:fit-content;":"width: fit-content;max-width:100%"},imgClass(){return this.vue_Scale?this.isBook?(this.isBook2,"test"):"":"test"},imgfit(){return this.vue_Scale?this.isBook?(this.isBook2,"scale-down"):"fill":"scale-down"},imgimgstyle(){return this.vue_Scale?this.isBook?this.isBook2?{height:"100%",width:"fit-content"}:{height:"100%",width:"fit-content"}:{width:"100%",height:"fit-content"}:{width:"fit-content",maxWidth:"100%"}},imgcontstyle(){if(this.vue_Scale){if(this.isBook){if(this.isBook2){let e=1;return this.pageNum%2&&(e*=-1),this.vue_RM=="RTL"&&(e*=-1),this.vue_Offset&&(e*=-1),"width:50%;height:100vh;align-items:"+(e==-1?"start":"end")}return"max-width:100%;height:100vh"}return"width:100%;height:fit-content;"}if(this.isBook2){const e=this.pageNum%2?this.vue_RM=="RTL"?"end":"start":this.vue_RM=="RTL"?"start":"end";return"width:50%;align-items:"+e}return"max-width:100%"}},watch:{pageNum(){this.getImg()}},methods:{getImg(){A(`/api/v1/manga/${this.$route.params.mangaID}/chapter/${this.chapterID}/page/${this.pageNum}?useCache=${this.$q.localStorage.getItem("useCache")}`).then(e=>{this.imgdata=e})}},setup(){return{imgdata:h("")}}});function q(e,s,t,n,o,d){return r(),l("div",{class:v(["column items-center justify-center",e.vue_Scale&&!e.isBook?"":"displayPage"]),style:g(e.imgcontstyle)},[c(E,{style:g([{"max-width":"-webkit-fill-available"},e.imgstyle]),loading:"lazy",class:v(e.vue_WT?e.isBook2?"q-mx-md":"q-ma-md":""),src:e.imgdata,fit:e.imgfit,imgClass:e.imgClass,imgStyle:e.imgimgstyle},null,8,["style","class","src","fit","imgClass","imgStyle"]),e.imgdata?B("",!0):(r(),_(k,{key:0,flat:"",style:{height:"100vh","background-color":"transparent",width:"100%"}},{default:u(()=>[c(b,{showing:!e.imgdata,color:"primary",class:"bg-transparent"},null,8,["showing"])]),_:1}))],6)}var W=R(O,[["render",q]]);const z=T({name:"chapterPage",components:{displayPage:W},emits:["setTitle"],methods:{myTweak(e){return{height:e?`calc(100vh - ${e}px)`:"100vh"}},onLoad(e,s){this.$fetchJSON(`/api/v1/manga/${this.$route.params.mangaID}/chapter/${this.currchapter}`).then(t=>{var n;this.items.push(t),this.currchapter!=parseInt(`${this.$route.params.chapterID}`)&&((n=this.$route.name)==null?void 0:n.toString())=="chapterpage"&&this.$router.replace(`/manga/${this.$route.params.mangaID}/chapter/${this.currchapter}`),s(),this.chapname=t.name,this.$emit("setTitle",`${this.vue_title} ${t.name}`),this.currchapter>=t.chapterCount&&this.$refs.infiniteScrol.stop(),this.currchapter++})},onIntersection(e){const s=e.target;e.isIntersecting?(this.pageIntersectEleArr.push(s),this.setReadPages(s)):this.pageIntersectEleArr=this.pageIntersectEleArr.filter(t=>!(t.dataset.pid==s.dataset.pid&&t.dataset.cid==s.dataset.cid))},setReadPages(e){const s=new FormData;if(s.append("lastPageRead",`${parseInt(e.dataset.pid)+1}`),this.$fetch(`/api/v1/manga/${this.$route.params.mangaID}/chapter/${e.dataset.cid}`,{method:"PATCH",body:s}),parseInt(e.dataset.pid)>=parseInt(e.dataset.pcount)-1){const t=new FormData;t.append("read","true"),this.$fetch(`/api/v1/manga/${this.$route.params.mangaID}/chapter/${e.dataset.cid}`,{method:"PATCH",body:t})}},goNextIntersector80(){if(this.scrolltimeout)if(this.scrolltimeout=!1,setTimeout(()=>{this.scrolltimeout=!0},500),this.pageIntersectEleArr.length>1){const e=this.pageIntersectEleArr[this.pageIntersectEleArr.length-1];if(e){const s=window.visualViewport;if(e.offsetTop>s.pageTop+s.height||e.offsetTop<s.pageTop)this.pageIntersectEleArr=this.pageIntersectEleArr.filter(t=>!(t.dataset.pid==e.dataset.pid&&t.dataset.cid==e.dataset.cid)),this.goNextIntersector80();else{this.pageIntersectEleArr=[e];const t=e.offsetTop+1;window.scrollTo({top:t,left:0,behavior:"smooth"})}}}else this.scroll80()},scroll80(){const e=window.visualViewport;window.scrollTo({top:e.pageTop+e.height*.8,left:0,behavior:"smooth"})},keyHandeler(e){e.key==" "&&(e.preventDefault(),this.goNextIntersector80())}},created(){window.addEventListener("keydown",this.keyHandeler)},beforeUnmount(){window.removeEventListener("keydown",this.keyHandeler)},computed:{isBook(){return["RTL","LTR","SinglePage"].includes(this.vue_RM)},isBook2(){return["RTL","LTR"].includes(this.vue_RM)},divClass(){return this.isBook2?"row items-center":""}},watch:{vue_title(){this.$emit("setTitle",`${this.chapname} ${this.vue_title}`)}},setup(){const e=h([]),s=h([]),t=N(),n=h(parseInt(`${t.params.chapterID}`)),o=Q(parseInt(`${t.params.mangaID}`)),d=o.vue_RM,m=o.vue_WT,i=o.vue_Scale,f=o.vue_Offset,y=o.vue_title,a=h("");return{items:s,currchapter:n,vue_RM:d,vue_WT:m,vue_Scale:i,vue_Offset:f,chapname:a,vue_title:y,pageIntersectEleArr:e,scrolltimeout:h(!0)}}}),H={key:0,style:{width:"50%"}},V={class:"col"},F={class:"col"},j={class:"row justify-center q-py-md"};function J(e,s,t,n,o,d){const m=P("displayPage");return r(),_(L,{onClick:e.goNextIntersector80,"style-fn":e.myTweak},{default:u(()=>[p("div",null,[c(C,{onLoad:e.onLoad,offset:e.$q.screen.height*5,ref:"infiniteScrol"},{loading:u(()=>[p("div",j,[c(S,{color:"primary",size:"40px"})])]),default:u(()=>[(r(!0),l($,null,w(e.items,(i,f)=>(r(),l("div",{key:f,class:v(e.divClass)},[e.vue_Offset&&e.isBook2?(r(),l("div",H)):B("",!0),(r(!0),l($,null,w(i.pageCount,(y,a)=>M((r(),_(m,{pageNum:e.vue_RM=="RTL"?a%2?a-1:a+1:a,chapterID:i.index,key:a,"data-pid":a,"data-cid":i.index,"data-pcount":i.pageCount,vue_RM:e.vue_RM,vue_WT:e.vue_WT,vue_Scale:e.vue_Scale,vue_Offset:e.vue_Offset},null,8,["pageNum","chapterID","data-pid","data-cid","data-pcount","vue_RM","vue_WT","vue_Scale","vue_Offset"])),[[D,e.onIntersection]])),128)),c(k,{style:g([{height:"100vh","max-height":"500px"},e.isBook2?"width:100%":""]),class:"column text-center q-ml-md"},{default:u(()=>[p("h5",V,"End of "+I(i.name),1),p("p",F,I(i.index>=i.chapterCount?"no chapters remaining":"keep scrolling for the next chapter"),1)]),_:2},1032,["style"])],2))),128))]),_:1},8,["onLoad","offset"])])]),_:1},8,["onClick","style-fn"])}var le=R(z,[["render",J]]);export{le as default};
